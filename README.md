# Exploring Local Potato Exploit to Perform Windows Privilege Escalation

## Background

- The Hot Potato exploit that emerged in 2016 followed several steps:
  - It first deceived the "NT AUTHORITY\SYSTEM" account into authenticating itself via NTLM to a TCP endpoint that the exploit controlled.
  - It then intercepted this authentication attempt (a process known as NTLM relay) to locally create a security token for the "NT AUTHORITY\SYSTEM" account. This was executed using a sequence of Windows API calls.
  - Lastly, it imitated the newly created token. This action is only possible if the attacker's current account holds the privilege to mimic security tokens, which is typically the case for most service accounts but not for most user-level accounts.

## What the Potato?

- **Hot Potato**: This vulnerability exploits the Windows NTLM authentication protocol by using man-in-the-middle (MitM) techniques to elevate privileges.
- **Rotten Potato**: This exploit manipulates the NTLM authentication process using a flaw in the DCOM (Distributed Component Object Model) activation service to escalate privileges.
- **Juicy Potato**: It uses a flaw in the DCOM activation service and the BITS (Background Intelligent Transfer Service) to gain SYSTEM privileges from a service account.
- **Sweet Potato**: combines elements from both the Juicy Potato and Rotten Potato exploits for exploiting the Windows RPC (Remote Procedure Call) service.


  <img src="https://i.imgur.com/ZXv08Qc.png" height="70%" width="70%" alt="Disk Sanitization Steps"/>

## NTLM Authentication

- **Type 1 Message**: The user's computer kicks off the authentication process by sending a packet, which may include its name and domain, to the server for approval.
- **Type 2 Message**: The server replies to the client with a unique "challenge," a random number, ensuring that client's credentials are not transferred directly over the network.
- **Type 3 Message**: The client responds to the server's challenge by mixing it with their password hash and sending this response back, allowing the server to validate the client's password.

## NTLM Local Authentication

1. **Type 1 Message**: Initiated by the client, this message sets the stage for the connection, agreeing on authentication terms and presenting the name and domain of the client's machine. If the server confirms these details as correct, it starts the local authentication process.
2. **Type 2 Message**: In this phase, the server forms a Security Context and relays its ID to the client via this message. Using the Security Context ID, the client can now establish a link with the connection.
3. **Type 3 Message**: Once the client successfully connects with the help of the Security Context ID, it communicates its success back to the server by sending an unpopulated Type 3 message, marking the completion of the local authentication process.

## Local Potato

- The LocalPotato takes advantage of a flaw in a special case of NTLM authentication called NTLM local authentication to trick a privileged process into authenticating a session the attacker starts against the local SMB Server.
- As a result, the attacker ends up having a connection that grants him access to any shares with the privileges of the tricked process, including special shares like C$ or ADMIN$

## Potato Magic

- Attacker prompts a privileged process to link to a rogue server they manage, similar to prior Potato exploits.
- The rogue server sets up Security Context A for this privileged connection, but doesn't send it back right away.
- Concurrently, the attacker introduces a rogue client that connects to the local SMB Server using their lower-level credentials.
- The client starts the connection by sending a Type 1 message, to which the server replies with a Type 2 message and the ID for a fresh Security Context B.
- The attacker switches the Context IDs between the two connections, causing the privileged process to mistakenly receive the SMB server's context.
- As a result, the privileged client, thinking it's the SYSTEM, associates with Security Context B of the SMB connection created by the attacker, allowing the attacker's client to access network shares with SYSTEM privileges.

## Abusing StorSvc to Execute Commands

- A new avenue for privilege escalation was discovered recently, allowing an attacker to take over a missing DLL to execute arbitrary commands with SYSTEM privileges.
- The issue with this approach is that an attacker would need to insert a DLL into the system's PATH to initiate it.
- By default, the Windows PATH only includes directories that can be written by privileged accounts.
- It may be possible to find systems where specific application installations have changed the PATH variable, making the system vulnerable, but this attack strategy is only applicable to certain situations.
- By combining this attack with LocalPotato, we can bypass this limitation and create a fully operational privilege escalation exploit.
- First, letâ€™s check what privileges the user has

## LPE via StorSvc Pre-requisites

- **RpcClient.exe**: This program will trigger the RPC call to SvcRebootToFlashingMode.
- **SprintCSP.dll**: This is the missing DLL we are going to hijack.
## Privilege Escalation

1. **Exploiting StorSvc**:
   - Replicate `SprintCSP.dll` to any directory found within the current `PATH`. You can confirm the `PATH` by executing the command:
     ```bash
     echo %PATH%
     ```
   - Target will be the `%SystemRoot%\system32` directory, i.e., `C:\windows\system32`.
   - Through the use of **LocalPotato**, gain the ability to perform arbitrary writes, allowing for copying `SprintCSP.dll` into `system32` even as an unprivileged user.
   - With the DLL in place, execute `RpcClient.exe` to initiate the call to `SvcRebootToFlashingMode`, activating the payload within the DLL.
   - Verify the exploit's success by checking if the user account now has Administrator privileges.

## Detection & Mitigation

- **Security Patches**: Stay updated with the security patches to prevent such attacks.
  - Microsoft patched the **CVE-2023-21746** vulnerability by altering how Windows manages NTLM authentication requests. The revised code validates the request through multiple checks.

- **Least Privilege Principle**: Restrict user access to only what's essential for their tasks.

- **Continuous Monitoring**: Develop detection rules such as YARA, SIGMA, or custom SIEM Rules for ongoing monitoring.

- **0(Zero) Patch Software**: For **CVE-2023-21746**, the new code verifies the request before its processing.

## References

- [Potatoes Windows Privesc](#)
- [CVE-2023-21746](#)
- [LPE via StorSvc](#)
- [LocalPotato Context](#)
- [LocalPotato Official Site](#)
